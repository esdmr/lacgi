\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{cgi}

\ExplSyntaxOn

\cs_new:Npn \g_cgi_env:Nn #1 #2 {
	\sys_get_shell:nnN { kpsewhich ~ --var-value ~ #2 } {
		\char_set_catcode_space:N \ %
	} \l_tmpa_tl
	\tl_trim_spaces:N \l_tmpa_tl
	\str_const:Nx #1 {\l_tmpa_tl}
}

\iow_new:N \g_cgi_header_iow
\iow_open:Nn \g_cgi_header_iow {\c_sys_jobname_str.cgi-header}
\prop_new:N \g_cgi_headers_prop

\cs_new:Npn \cgi_header:nn #1 #2 {
	\prop_put:Nnn \g_cgi_headers_prop {#1} {#2}
}

\cs_generate_variant:Nn \cgi_header:nn {nx}
\cs_generate_variant:Nn \cgi_header:nn {xn}
\cs_generate_variant:Nn \cgi_header:nn {xx}

\cs_new:Nn \cgi_header_write: {
	\prop_map_inline:Nn \g_cgi_headers_prop {
		\iow_now:Nx \g_cgi_header_iow {##1:~##2}
	}

	\seq_map_inline:Nn \g_cgi_cookies_seq {
		\iow_now:Nx \g_cgi_header_iow {##1}
	}

	\iow_close:N \g_cgi_header_iow
}

\cs_new:Npn \cgi_header_alias:Nn #1 #2 {
	\def #1 ##1 {
		\cgi_header:nn {#2} {##1}
	}
}

\iow_new:N \g_cgi_body_iow
\iow_open:Nn \g_cgi_body_iow {\c_sys_jobname_str.cgi-body}

\cs_new:Npn \cgi_body:n #1 {
	\iow_now:Nn \g_cgi_body_iow {#1}
}

\cs_generate_variant:Nn \cgi_body:n {x}

\let \cgiHeader = \cgi_header:nn
\let \cgiHeaderX = \cgi_header:xx
\let \cgiHeaderNX = \cgi_header:nx
\let \cgiHeaderXN = \cgi_header:xn
\let \cgiHeaderWrite = \cgi_header_write:
\let \cgiBody = \cgi_body:n
\let \cgiBodyX = \cgi_body:x
\cgi_header_alias:Nn \cgiContentType {Content-Type}
\cgi_header_alias:Nn \cgiStatus {Status}

\ExplSyntaxOff

\def \cgiEnd {
	\cgiHeaderWrite
	\begin{document}
	~
	\end{document}
	\endinput
}
